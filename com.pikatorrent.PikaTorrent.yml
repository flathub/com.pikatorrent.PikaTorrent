app-id: com.pikatorrent.PikaTorrent
runtime: org.freedesktop.Platform
runtime-version: "24.08"
sdk: org.freedesktop.Sdk
command: pikatorrent
finish-args:
  - --share=ipc
  - --share=network
  - --filesystem=xdg-download
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  # To check connectivity
  - --system-talk-name=org.freedesktop.NetworkManager
cleanup:
modules:
  - name: PikaTorrent
    buildsystem: simple
    build-commands:
      - mv pikatorrent /app/pikatorrent
      - mkdir -p /app/bin
      - ln -s /app/pikatorrent/pikatorrent /app/bin/pikatorrent
    post-install:
      - install -Dm644 com.pikatorrent.PikaTorrent.desktop ${FLATPAK_DEST}/share/applications/com.pikatorrent.PikaTorrent.desktop
      - install -Dm644 com.pikatorrent.PikaTorrent.metainfo.xml ${FLATPAK_DEST}/share/metainfo/com.pikatorrent.PikaTorrent.metainfo.xml
      # TODO: Use svg
      - install -Dm644 icon.png ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png
    modules:
      - shared-modules/libayatana-appindicator/libayatana-appindicator-gtk3.json
      - name: libass
        cleanup:
          - /include
          - /lib/pkgconfig
        config-opts:
          - --disable-static
          - --enable-asm
          - --enable-harfbuzz
          - --enable-fontconfig
        sources:
          - type: git
            url: https://github.com/libass/libass.git
            tag: 0.17.4
            commit: bbb3c7f1570a4a021e52683f3fbdf74fe492ae84
            x-checker-data:
              type: git
              tag-pattern: ^(\d\.\d{1,3}\.\d{1,2})$

      - name: libplacebo
        buildsystem: meson
        config-opts:
          - -Dvulkan=enabled
          - -Dshaderc=enabled
        cleanup:
          - /include
          - /lib/pkgconfig
        sources:
          - type: git
            url: https://github.com/haasn/libplacebo.git
            tag: v7.349.0
            commit: 1fd3c7bde7b943fe8985c893310b5269a09b46c5
            # fix from https://github.com/flathub/io.mpv.Mpv/commit/b3001a27d9f7f09edee2c6bd6de25237f2f468b4
            # Disabled libplacebo update above v7.349.0, though it compiles, but videos do not play/work with freedesktop sdk 24.08 due to vulkan 1.0; perhaps 25.08 may work.
            #x-checker-data:
            #  type: git
            #  tag-pattern: ^v([\d.]+)$

      - name: ffmpeg
        cleanup:
          - /include
          - /lib/pkgconfig
          - /share/ffmpeg/examples
        config-opts:
          - --disable-doc
          - --disable-programs"
          - --disable-encoders"
          - --disable-debug
          - --disable-doc
          - --disable-static
          - --enable-gnutls
          - --enable-gpl
          - --enable-version3
          - --enable-shared
          - --enable-libass
          - --enable-vulkan

        sources:
          - type: git
            url: https://github.com/FFmpeg/FFmpeg.git
            commit: db69d06eeeab4f46da15030a80d539efb4503ca8
            tag: n7.1.1
            x-checker-data:
              type: git
              tag-pattern: ^n([\d.]{3,7})$

      - name: libmpv
        buildsystem: meson
        config-opts:
          - -Dlibmpv=true
          - --buildtype=release
          - -Dbuild-date=false
          - -Dmanpage-build=disabled
          - -Dsdl2=enabled
          - -Dvulkan=enabled
        cleanup:
          - /include
          - /lib/pkgconfig
        sources:
          - type: git
            url: https://github.com/mpv-player/mpv.git
            tag: v0.40.0
            commit: e48ac7ce08462f5e33af6ef9deeac6fa87eef01e
            x-checker-data:
              type: git
              tag-pattern: ^v([\d.]+)$
    sources:
      - type: archive
        url: https://github.com/G-Ray/pikatorrent/releases/download/v0.14.0/PikaTorrent-v0.14.0-linux-x64.zip
        sha256: ed4ae71960030a9c594fa3f975673f390458119912d4ca87728a62c6988184e2
        dest: pikatorrent
        strip-components: 0
        only-arches:
          - x86_64
        x-checker-data:
          is-main-source: true
          type: json
          url: https://api.github.com/repos/G-Ray/pikatorrent/releases/latest
          version-query: .tag_name | sub("^v"; "")
          timestamp-query: .published_at
          url-query:
            .assets | map(.browser_download_url | select(endswith("-linux-x64.zip")))
            | first

      - type: archive
        url: https://github.com/G-Ray/pikatorrent/releases/download/v0.14.0/PikaTorrent-v0.14.0-linux-arm64.zip
        sha256: 0b42e98e8d98f35620114b0ec2ce818af7975835d49c5cb9af64cf1192e89d7d
        dest: pikatorrent
        strip-components: 0
        only-arches:
          - aarch64
        x-checker-data:
          type: json
          url: https://api.github.com/repos/G-Ray/pikatorrent/releases/latest
          version-query: .tag_name | sub("^v"; "")
          timestamp-query: .published_at
          url-query:
            .assets | map(.browser_download_url | select(endswith("-linux-arm64.zip")))
            | first

      - type: file
        dest-filename: com.pikatorrent.PikaTorrent.metainfo.xml
        url: https://raw.githubusercontent.com/G-Ray/pikatorrent/v0.14.0/app/linux/packaging/com.pikatorrent.PikaTorrent.metainfo.xml
        sha256: 4be70cc94061d8cadec942211f47e7dc4b8516fb5384e696fe60da736b6df061
        x-checker-data:
          type: json
          url: https://api.github.com/repos/G-Ray/pikatorrent/releases/latest
          tag-query: .tag_name
          version-query: .tag_name | sub("^v"; "")
          timestamp-query: .published_at
          url-query:
            '"https://raw.githubusercontent.com/G-Ray/pikatorrent/" + $tag
            + "/app/linux/packaging/com.pikatorrent.PikaTorrent.metainfo.xml"'

      - type: file
        dest-filename: com.pikatorrent.PikaTorrent.desktop
        url: https://raw.githubusercontent.com/G-Ray/pikatorrent/v0.14.0/app/linux/packaging/com.pikatorrent.PikaTorrent.desktop
        sha256: 4bd452e7a3382009c96ce731b4e3d38ffc570c778808b5979d0d1ecb9a1dfcfa
        x-checker-data:
          type: json
          url: https://api.github.com/repos/G-Ray/pikatorrent/releases/latest
          tag-query: .tag_name
          version-query: .tag_name | sub("^v"; "")
          timestamp-query: .published_at
          url-query:
            '"https://raw.githubusercontent.com/G-Ray/pikatorrent/" + $tag
            + "/app/linux/packaging/com.pikatorrent.PikaTorrent.desktop"'

      - type: file
        dest-filename: icon.png
        url: https://raw.githubusercontent.com/G-Ray/pikatorrent/v0.14.0/app/linux/packaging/icon.png
        sha256: f59d0e72153051e9babea4889af24c8cf05a46e1cdb7ef26179ba24a62d63604
        x-checker-data:
          type: json
          url: https://api.github.com/repos/G-Ray/pikatorrent/releases/latest
          tag-query: .tag_name
          version-query: .tag_name | sub("^v"; "")
          timestamp-query: .published_at
          url-query:
            '"https://raw.githubusercontent.com/G-Ray/pikatorrent/" + $tag
            + "/app/linux/packaging/icon.png"'
